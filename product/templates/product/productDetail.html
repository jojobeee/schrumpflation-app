{% extends 'product/base.html' %}
{% load render_table from django_tables2 %} 

{% block body %}
<h1>Product: {{product.name}}</h1>

  <div class = "ms-3 mt-1">
    <h2>Brand: {{product.brand}}</h2>
    <p> </p>
      <div class="row">
        <div class="col-md-6 custom-table-container">
          {% render_table table %}
        </div>
        <div class="col-md-6">
          <h2>Price per Kg or L Graph</h2>
          <div id="priceGraph"></div>
          <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
          <script>
            var data = {{ graph_data|safe }};
            console.log('Graph Data:', data);  // Check data received

            // Extract dates and prices per Kg or L
            var dates = data.map(item => item.purchase_date);
            var pricesPerKgOrL = data.map(item => parseFloat(item.price_per_kg_or_l));

            // Filter out NaN (invalid) prices
            var validPrices = pricesPerKgOrL.filter(price => !isNaN(price));
            console.log('Dates:', dates);
            console.log('Prices per Kg or L:', validPrices);

            // Create Plotly trace
            var trace = {
              x: dates,
              y: validPrices,
              type: 'scatter',
              mode: 'lines+markers',
              marker: { size: 8 }
            };

            // Plotly layout settings
            var layout = {
              title: 'Price per Kg or L over Time',
              xaxis: { title: 'Date' },
              yaxis: { title: 'Price per Kg or L' }
            };

            // Plot the graph
            Plotly.newPlot('priceGraph', [trace], layout);
          </script>




        </div>
      </div>



  
  </div>

  <div class="row mt-4">
    <div class="col-12">
        <h2>Price and size changes over time</h2>
        {% if price_change.change_p > 0.00 %}
            <p>Between the last purchase ({{ price_change.previous_date }}) and this purchase ({{ price_change.newest_date }}), the <b>price</b> increased by {{ price_change.change_p }}%</p>
        {% elif price_change.change_p < 0.00 %}
            <p>Between the last purchase ({{ price_change.previous_date }}) and this purchase ({{ price_change.newest_date }}), the <b>price</b> decreased by {{ price_change.change_p }}%</p>
        {% elif price_change.change_p == 0.00 %}
            <p>Between the last purchase ({{ price_change.previous_date }}) and this purchase ({{ price_change.newest_date }}), the <b>price</b> remained the same.</p>
        {% else %}
            <p>Not enough data to calculate <b>price</b> change.</p>
        {% endif %}

      {% if size_change.change_s > 0.00 %}
          <p>The <b>size</b> of the packaging increased by {{ size_change.change_s }}%</p>
      {% elif size_change.change_s < 0.00 %}
          <p>The <b>size</b> of the packaging decreased by {{ size_change.change_s }}%</p>
      {% elif size_change.change_s == 0.00 %}
          <p>The <b>size</b> of the packaging remained the same.</p>
      {% else %}
          <p>Not enough data to calculate <b>size</b> change.</p>
      {% endif %}
    </div>
  </div>  

{% endblock %}
